<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>admin</title>
    <link rel="stylesheet" href="static/css/bootstrap.min.css" />
    <script src="static/js/jquery-1.12.4.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css"
      integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="static/css/admin.css" />
  </head>
  <body>
    <div class="page">
      <h5>产品列表 <sub>（排序规则：时间/数字越大越靠前）</sub></h5>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>id</th>
            <th>标题</th>
            <th>小标题</th>
            <th>分类</th>
            <th>封面图</th>
            <!-- <th>介绍</th> -->
            <th>流行度</th>
            <th>时间排序</th>
            <th>首页推荐</th>
          </tr>
        </thead>
        <tbody id="tbody" class="pure-form pure-form-stacked"></tbody>
      </table>
    </div>

    <script>
      $(function () {
        initData();

        $('#addBtn').click(function () {
          $('#formRef').show();
          $('#addBtn').hide();
        });
      });
    </script>

    <script>
      var productId = null;

      // 初始化页面 刷新列表
      function initData() {
        $('#formRef').hide();
        $('#addBtn').show();

        $.ajax({
          url: '/product',
          type: 'GET',
          success: function (row) {
            $('#tbody').empty();

            let str = '';
            let resData = JSON.parse(row);
            resData.data.forEach((element) => {
              let title = `<input type="text" onblur="updateInfo(${element.id}, 'title', this)" value="${element.title || ''}">`;
              let type = `<input type="text" onblur="updateInfo(${element.id}, 'type', this)" value="${element.type || ''}">`;

              let classify = `<select name="classify" style="height: 2.5em;" onchange="updateInfo(${element.id},'classify', this)">
                            <option value="ring" ${element.classify === 'ring' ? 'selected' : ''}>戒指</option>
                            <option value="earring" ${element.classify === 'earring' ? 'selected' : ''}>耳环</option>
                            <option value="necklace" ${element.classify === 'necklace' ? 'selected' : ''}>项链</option>
                            <option value="bracelet" ${element.classify === 'bracelet' ? 'selected' : ''}>手链/手镯</option>
                          </select>`;

              let popular = `<input type="number" onblur="updateInfo(${element.id}, 'popular', this)" value="${element.popular || ''}">`;

              let createTime = `<input type="date" onchange="updateInfo(${element.id},'createTime', this)" value="${element.createTime}">`;

              let img = `<a target="_blank" href="/detail.html?id=${element.id}"><img class='mini-img' src="images/product/${element.cover}" alt=""></a>`;
              str += `<tr>
                      <td>${element.id}</td>
                      <td>${title}</td>
                      <td>${type}</td>
                      <td>${classify}</td>
                      <td onclick='addOrUpdateCover(${element.id})'>${element.cover === 'undefined' || !element.cover ? 'empty' : img}</td>
                      <td>${popular}</td>
                      <td>${createTime}</td>
                      <td>${element.recommendIndex || ''}</td>
                    </tr>`;
              // <td>${element.describe || ''}</td>
            });
            $('#tbody').append($(str));
          },
        });
      }

      // 新增
      $('#button').click(function () {
        console.log('formRef', $('#formRef').serialize());
        return;
        $.ajax({
          url: '/add',
          type: 'post',
          data: $('#formRef').serialize(),
          dataType: 'JSON',
          success: function (res) {
            $('#formRef').hide();
            $('#addBtn').show();
            initData();
          },
          error: function () {
            alert('error');
          },
        });
      });

      // 更新一个属性值
      function updateInfo(id, prop, _this) {
        if (!$(_this).val()) return;
        let newVal = $(_this).val();

        var formData = {
          prop: prop,
          value: newVal,
          id: id,
        };

        $.ajax({
          url: `/product/update`,
          type: 'post',
          data: formData,
          dataType: 'JSON',
          success: function (res) {
            initData();
          },
          error: function (e) {
            console.log('error', e);
          },
        });
      }
    </script>
  </body>
</html>
